# BNF Viewer (US) 설정

env: "viewer"
site_url: "http://trader.p-e.kr"

database:
  path: "data/market_data.db"

kis:
  env: "prod"
  base_url_prod: "https://openapi.koreainvestment.com:9443"
  base_url_paper: "https://openapivts.koreainvestment.com:29443"
  app_key: "${KIS_APP_KEY}"
  app_secret: "${KIS_APP_SECRET}"
  account_no: "${KIS_ACCOUNT_NO}"
  acnt_prdt_cd: "${KIS_ACNT_PRDT_CD}"
  custtype: "P"
  token_cache_path: ".cache/kis_token.json"
  rate_limit_sleep_sec: 0.1
  rate_limiter_total_tps: 10
  # Smooth bursts to reduce EGW00201 (per-second) errors while keeping ~10 TPS average.
  rate_limiter_max_tokens: 2
  rate_limiter_trading_reserve: 1
  timeout_connect_sec: 5
  timeout_read_sec: 20
  max_retries: 8
  backoff_base_sec: 2
  backoff_cap_sec: 60
  backoff_jitter_sec: 0.5
  consecutive_error_cooldown_after: 10
  consecutive_error_cooldown_sec: 180
  auth_forbidden_cooldown_sec: 600
  session_reset_every: 3

# DB -> CSV export (선택)
export_csv:
  enabled: true
  out_dir: "data/csv"
  mode: "overwrite"
  tables:
    - "universe_members"
    - "sector_map"
    - "refill_progress"
    - "job_runs"
    - "ovrs_stock_info"
    - "stock_info"
    - "universe_changes"
  refill_export_every: 0

# Discord 알림 (viewer 기본값: off)
discord:
  enabled: false
  webhook: "${DISCORD_WEBHOOK_URL}"

# 실시간 모니터링(REST + WebSocket) 세팅
monitor:
  enabled: false
  max_ws_subs: 20

# 전략 파라미터 (Selection 화면에 반영)
# - 코드는 기존 프로젝트 키명을 유지합니다.
#   (NASDQ100=kospi, S&P500=kosdaq 로 매핑)
strategy:
  entry_mode: "mean_reversion"   # mean_reversion | trend_follow
  rank_mode: "amount"           # amount | ret3 | disparity 등
  liquidity_rank: 300
  min_amount: 500000000          # $ 기준 거래대금(대략적인 필터). 필요 시 조정
  disparity_buy_kospi: -0.05     # NASDAQ100 진입 임계치
  disparity_buy_kosdaq: -0.06    # S&P500 진입 임계치
  disparity_sell: -0.01
  stop_loss: -0.08
  max_holding_days: 3
  max_positions: 20
  max_per_sector: 3
  trend_ma25_rising: false
  selection_horizon_days: 1

# DB 감시/증분수집 (서버 백그라운드 watchdog)
watchdog:
  enabled: true
  accuracy_enabled: false
  interval_sec: 900
  daily_min_missing: 1
  daily_limit: 0
  daily_stale_days: 2
  daily_chunk_days: 90
  daily_cooldown_sec: 1800
  invalid_latest_enabled: true
  invalid_latest_amount_threshold: 0
  invalid_latest_volume_threshold: 0
  daily_codes_file: "data/csv/watchdog_daily_codes.csv"
  refill_chunk_days: 150
  refill_sleep_sec: 0.1
  refill_max_missing_per_cycle: 1
  refill_cooldown_sec: 120

# 자동매매(웹훅) - 기본 OFF (worker 프로세스로 구동 권장)
autotrade:
  enabled: true
  # 실발주 스위치. enabled=true라도 send_enabled=false면 웹훅 발송을 하지 않습니다.
  send_enabled: true
  # 자동매매정보 파일에서 기본값을 파싱합니다. (webhook_url/password 등)
  info_path: "/home/ubuntu/자동매매정보2.txt"
  webhook_url: ""
  password: "${AUTOTRADE_WEBHOOK_PASSWORD}"
  kis_number: "${AUTOTRADE_KIS_NUMBER}"
  default_amount: 1
  poll_interval_sec: 60
  # Selection 결과를 주기적으로 동기화하여 수동 watchlist 드리프트를 줄입니다.
  sync_selection_enabled: true
  sync_selection_interval_sec: 300
  sync_selection_max_codes: 20
  # Selection에서 빠진 BUY 대기/실패 큐는 자동 취소 처리합니다.
  cancel_missing_selected: true
  # 이탈(SELL) 자동큐는 생성/발송하지 않습니다.
  generate_sell_queue: false
  # 지난 큐 정리 보존일(일): EXPIRED/CANCELLED 큐 삭제 기준.
  purge_expired_after_days: 1
  # 엔진 per-code 그리드서치(느림). watchlist가 작을 때만 권장.
  optimize: true
  optimize_lookback_bars: 2000
